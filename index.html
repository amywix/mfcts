<!-- Dynamic Timesheet with Auto Hours and PDF Export -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Timesheet</title>
  <style>
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    input, select { width: 100%; }
  </style>
</head>
<body>
  <h1>Support Worker Timesheet</h1>

  <label for="supportWorkerName">Support Worker:</label>
  <input type="text" id="supportWorkerName" />
  <br/>
  <label for="weekStarting">Week Starting:</label>
  <input type="date" id="weekStarting" />
  <br/><br/>
  <table>
    <thead>
      <tr>
        <th>Day</th><th>Shift</th><th>Start Time</th><th>End Time</th><th>Hours</th><th>Client</th><th>Sleepover</th>
      </tr>
    </thead>
    <tbody id="timesheetBody"></tbody>
    <tfoot>
      <tr>
        <td colspan="4"><strong>Total Hours</strong></td>
        <td id="totalHours">0.00</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>
  <br/>
  <button id="downloadPDF">Download PDF</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const clients = ["Wayne", "Richard", "Jayden", "Sandra", "Lani", "Jess", "Lorna", "Amy", "Chris", "Brendan", "Kimberly Court"];

    function formatDateDisplay(date) {
      return date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    }

    function generateTimesheet(startDateStr) {
      const tbody = document.getElementById('timesheetBody');
      tbody.innerHTML = '';

      const startDate = new Date(startDateStr);

      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `<td colspan="7"><strong>${formatDateDisplay(date)}</strong></td>`;
        tbody.appendChild(headerRow);

        for (let shift = 1; shift <= 3; shift++) {
          const row = document.createElement('tr');
          row.setAttribute('data-day', dateStr);
          row.setAttribute('data-shift', shift);

          const clientOptions = ['<option value="">Select Client</option>', ...clients.map(c => `<option>${c}</option>`)].join('');

          row.innerHTML = `
            <td></td>
            <td>Shift ${shift}</td>
            <td><input type="time" class="start-time" data-day="${dateStr}" data-shift="${shift}" /></td>
            <td><input type="time" class="end-time" data-day="${dateStr}" data-shift="${shift}" /></td>
            <td class="hours-cell" data-day="${dateStr}" data-shift="${shift}">0.00</td>
            <td><select class="client-select" data-day="${dateStr}" data-shift="${shift}">${clientOptions}</select></td>
            <td style="text-align:center"><input type="checkbox" class="sleepover-checkbox" data-day="${dateStr}" data-shift="${shift}" /></td>
          `;
          tbody.appendChild(row);
        }
      }
      attachChangeListeners();
    }

    function calculateHours() {
      let total = 0;
      document.querySelectorAll('.shift-row').forEach(row => {
        const day = row.dataset.day;
        const shift = row.dataset.shift;
        const startInput = row.querySelector(`.start-time[data-day="${day}"][data-shift="${shift}"]`);
        const endInput = row.querySelector(`.end-time[data-day="${day}"][data-shift="${shift}"]`);
        const hoursCell = row.querySelector(`.hours-cell[data-day="${day}"][data-shift="${shift}"]`);

        if (startInput && endInput && hoursCell && startInput.value && endInput.value) {
          let start = new Date(`${day}T${startInput.value}`);
          let end = new Date(`${day}T${endInput.value}`);
          if (end < start) end.setDate(end.getDate() + 1);

          const diff = (end - start) / 3600000;
          const hrs = Math.max(0, diff).toFixed(2);
          hoursCell.textContent = hrs;
          total += parseFloat(hrs);
        } else if (hoursCell) {
          hoursCell.textContent = '0.00';
        }
      });
      document.getElementById('totalHours').textContent = total.toFixed(2);
    }

    function attachChangeListeners() {
      document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', calculateHours);
      });
    }

    document.getElementById('weekStarting').addEventListener('change', (e) => {
      generateTimesheet(e.target.value);
    });

    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const sunday = new Date(today);
      sunday.setDate(today.getDate() - today.getDay());
      const isoDate = sunday.toISOString().split('T')[0];
      document.getElementById('weekStarting').value = isoDate;
      generateTimesheet(isoDate);
    });

    document.getElementById('downloadPDF').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 20;
      doc.setFontSize(12);
      doc.text(`Support Worker Timesheet`, 20, y);
      y += 8;
      doc.text(`Name: ${document.getElementById('supportWorkerName').value || ''}`, 20, y);
      y += 6;
      doc.text(`Week Starting: ${document.getElementById('weekStarting').value || ''}`, 20, y);
      y += 10;

      doc.text("Date | Shift | Start | End | Hours | Client | Sleepover", 20, y);
      y += 6;

      document.querySelectorAll('tr[data-day]').forEach(row => {
        const day = row.dataset.day;
        const shift = row.dataset.shift;
        const start = row.querySelector('.start-time').value;
        const end = row.querySelector('.end-time').value;
        const hours = row.querySelector('.hours-cell').textContent;
        const client = row.querySelector('.client-select').value;
        const sleep = row.querySelector('.sleepover-checkbox').checked ? 'Yes' : 'No';

        if (start || end || hours !== '0.00') {
          const line = `${day} | ${shift} | ${start} | ${end} | ${hours} | ${client} | ${sleep}`;
          doc.text(line, 20, y);
          y += 6;
          if (y > 280) { doc.addPage(); y = 20; }
        }
      });

      y += 10;
      doc.text(`Total Hours: ${document.getElementById('totalHours').textContent}`, 20, y);

      doc.save("timesheet.pdf");
    });
  </script>
</body>
</html>
